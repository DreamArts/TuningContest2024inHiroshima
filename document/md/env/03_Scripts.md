# スクリプトの紹介

競技に必要、または利用できそうなスクリプトを用意しています。それぞれの概要を説明します。

注意:

- すべて、スクリプト配置ディレクトリ内で直接実行してください。
- ファイルを削除するスクリプトが含まれます。実行環境にお気をつけください。

## 初期設定スクリプト

場所: VM 内 (`/home/azureuser/entry.sh`)  
\* リポジトリには含まれていません。

入力されたリポジトリをクローンし、`init.sh` を実施します。
必要なファイルが`/.da`ディレクトリからリポジトリ内にコピーされ、[リストア & マイグレーション](#リストア--マイグレーション) が実行されます。

```
$ bash entry.sh
forkしたリポジトリのURLを入力ください: https://github.com/your-name/TuningContest2024inHiroshima.git
```

## 評価スクリプト

場所: `ルートディレクトリ/run.sh`

リストア・コンテナ再起動・マイグレーション・e2e テスト・負荷試験・採点を順次実行します。

```
$ bash run.sh
```

上記ステップは、以降の各種項目で紹介されるスクリプトで個別に実行可能です。

制約及び注意:

- ローカル環境だと e2e テストがタイムアウトする可能性が高いため、評価スクリプト内ではスキップされます。ローカル環境で e2e テストを実施したい場合は個別のスクリプトを実行してください。

## コンテナ再起動

場所: `app/restart_container.sh`

`app/`の現在の内容でイメージおよびコンテナを作成し、サービスを立ち上げます。

```
$ cd app
$ bash restart_container.sh
```

## リストア & マイグレーション

場所: `benchmarker/restore_and_migration.sh`

採点時に実施される MySQL データのリストア・コンテナ再起動・[簡易 DB マイグレーション](./02_Scoring.md#簡易-db-マイグレーション機能)を順次実施します。

マイグレーションの実行に時間がかかることがあります。

```
$ cd benchmarker
$ bash restore_and_migration.sh
```

## API テスト

場所: `benchmarker/e2e.sh`

採点時に実施される API テストを制約付きで実行できます。

最新の内容でテストしたい場合は、別途リストア & マイグレーションスクリプトを実行してください。

制約及び注意:

- チューニングがされていない初期状態だと、タイムアウトで失敗する可能性があります。
- 評価スクリプトとは異なり、http://localhost/ 宛にテストを実施します。
- このスクリプトの結果は OK だが負荷試験のレスポンスが NG の場合、後者が優先されます。

```
$ cd benchmarker
$ bash e2e.sh
```

## 負荷試験 & 採点

場所: `benchmarker/run_k6_and_score.sh`

現在起動しているサービスに対し、採点を行います。実行には数分かかります。

最新の内容で採点したい場合は、リストア & マイグレーションスクリプトを実行してください。

```
$ cd benchmarker
$ bash run_k6_and_score.sh
```
