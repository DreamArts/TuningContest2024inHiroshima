# 採点について

チューニング結果を各チームの VM に反映し、[評価スクリプト](./03_Scripts.md#評価スクリプト)をそれぞれの VM 内で実行することで採点ができます。

評価スクリプトでは、以下のプロセスで評価を行います。

- Step1. データベースを初期状態に戻す (顧客データをセット)
- Step2. 簡易 DB マイグレーションの実行
- Step3. API 動作テスト (e2e テスト)の実施
- Step4. 負荷試験の実施
- Step5. スコアの計算
- Step6. スコアの表示 & 運営への送信

Step3 では[API 仕様書](../../openapi/openapi.yaml)をベースに、主要な要件を満たしているかをチェックします。問題があった場合はそこで採点が停止します。

Step4 では一定時間各 API に対して多数のリクエストを行います。

Step5 では Step4 で処理できたリクエスト数をベースにスコアが計算されます。

Step6 で画面に表示されたスコアが、その時点のチームの持ち点になります。

\*スコア上位グループについては、成果物に対して追加で審議される場合があります。

## Step2 の補足

### 簡易 DB マイグレーション機能

評価スクリプトを実行する度にデータベースの状態は戻ってしまいますが、あらかじめ登録された SQL を実行させ、テーブル等への変更を採点前に反映させることができます。

`app/`ディレクトリの`mysql/mysql_migration/`に置かれた{数字}\_\*.sql ファイルは、採点前に実行されます。
0_name.sql, 1_name.sql...という名称のファイルを置いておくことで、番号が若い順に実行されていきます。

## Step4 の補足

### シナリオ

- Step4 ではシナリオと呼ばれる、一連の API 実行をひとまとまりとした処理を繰り返し実行します。シナリオとはユーザーの操作を模した一連の処理であり、`ログイン → ユーザー一覧の取得 → ユーザーアイコン画像の取得 → ユーザーの検索 → マッチグループ一覧の取得 → マッチグループの作成`という順で API が同期実行されます。
- シナリオ内の各 API は、それぞれ 50 秒でタイムアウトします。
- ログイン API に失敗した場合は、そのシナリオは中断され新たにシナリオを開始します。
- その他の API が失敗した場合は、次の API に進みます。

### 負荷試験の詳細

Step4 では、負荷試験ツール「k6」を用いて、{環境 ID}.ftt2306.dabaas.net に対して HTTPS 接続で下記の手順で負荷試験を実施します。

1. 試験開始後 60 秒かけて徐々に接続が確立、ピーク時には 120 接続が確立され、それぞれの接続から [シナリオ](#シナリオ) が実行されます。
2. それぞれの接続で、シナリオが完了した後再びシナリオを実行する、という動作を繰り返します。
3. 負荷試験開始後 60 秒が経過した時点でレスポンスを待っているリクエストについては、そこからさらに最大 60 秒間レスポンスの返却を待機します。ただし、上述したタイムアウト時間 50 秒を超えてレスポンスを待つことはありません。

## Step5 の補足

Step5 では、さらに以下のステップでスコアが求められます。

- Step5-1. Step4.の結果から、各 API の成功応答回数と\*失敗応答回数を求める
- Step5-2. それぞれの API について、下記に定めた補正係数を成功応答回数にかけた点数を基本点とする
- Step5-3. 5-2.の基本点に対し、5-1. で求めた失敗応答回数 x **20 点**を減点し、\*最終スコアを計算する

\* 失敗とは、API 仕様書に定められた成功時以外のステータスコードが返ったリクエストのことを指します。

\* ただし、本競技ではタイムアウトとなったリクエストは失敗として扱いません。

\* 最終スコアが 0 点を下回った場合、0 点として扱います。

補正係数:

| API                                | score |
| ---------------------------------- | ----- |
| POST /session                      | 3     |
| GET /users                         | 3     |
| GET /users/user-icon/{userIconId}  | 1     |
| GET /users/search                  | 3     |
| GET /match-groups/members/{userId} | 5     |
| POST /match-groups                 | 10    |
